<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Web Page Test</title>
</head>

<body>
    <h1>网页到扩展程序的通信测试</h1>
    <p>当前 URL **必须**是 <code>https://*.github.io/*</code> 才能成功连接。</p>
    <p>请打开浏览器控制台（F12）查看结果。</p>

    <script>
        const TARGET_EXT_A_ID = "becggllopbkfnfejhicfaphcinfkmpfo";

        console.log(`--- 网页开始向 ${TARGET_EXT_A_ID} 发送测试 ---`);

        // 检查扩展程序通信 API 是否可用
        if (typeof chrome !== 'undefined' && chrome.runtime) {

            // 1. 测试一次性消息 (runtime.sendMessage)
            chrome.runtime.sendMessage(
                TARGET_EXT_A_ID,
                { command: "WEB_PAGE_ONETIME_MESSAGE" },
                function (response) {
                    if (chrome.runtime.lastError) {
                        console.error("[网页 失败] 网页消息失败:", chrome.runtime.lastError.message);
                        console.error("失败原因通常是：扩展程序未加载、ID错误，或URL未在externally_connectable中匹配。");
                    } else {
                        console.log("[网页 成功] 收到 Ext A 响应:", response);
                    }
                }
            );

            // 2. 测试长期连接 (runtime.connect)
            try {
                const port = chrome.runtime.connect(TARGET_EXT_A_ID, { name: "WebPage-Port" });

                port.onMessage.addListener(function (msg) {
                    console.log("[网页 成功] 收到连接消息:", msg);
                });

                port.onDisconnect.addListener(function () {
                    if (chrome.runtime.lastError) {
                        console.error("[网页 失败] 连接断开错误:", chrome.runtime.lastError.message);
                    } else {
                        console.log("[网页] 长期连接断开");
                    }
                });

                port.postMessage({ command: "WEB_PAGE_CONNECT_MESSAGE" });

            } catch (e) {
                console.error("[网页 失败] 建立连接时发生异常:", e);
            }

        } else {
            console.error("无法访问 chrome.runtime。请确保扩展程序通信API在您的内核中已启用。");
        }
    </script>
</body>

</html>
